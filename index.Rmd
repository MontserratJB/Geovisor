---
title: "Proyecto de amojonamiento, datos GNSS"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(dplyr)
library(sf)
library(leaflet)
library(leaflet.providers)
library(leaflet.extras)
library(leaflet.extras2)
library(htmlwidgets)
library(htmltools)
```

```{=html}
<!-- Meta tag para viewport responsive -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<!-- CSS responsive optimizado para móviles -->
<style>
/* Ocultar encabezados de flexdashboard */
.navbar-brand {
  display: none !important;
}
.navbar-header {
  display: none !important;
}
.navbar {
  display: none !important;
}
.navbar-inverse {
  display: none !important;
}
.section.level1 h1 {
  display: none !important;
}
.chart-title {
  display: none !important;
}

/* Reset y configuración base */
body, html {
  margin: 0 !important;
  padding: 0 !important;
  width: 100% !important;
  height: 100% !important;
}
.container-fluid {
  padding: 0 !important;
  width: 100% !important;
}

/* Encabezado responsive */
.header-container {
  width: 100%;
  text-align: center;
  background-color: #ffffff;
  padding: 0;
  margin: 0;
}

.header-container img {
  width: 100%;
  height: auto;
  display: block;
  margin: 0;
  max-height: 80px;
}

/* Estilos para popups en móviles */
.leaflet-popup-content {
  white-space: normal !important;
  word-wrap: break-word !important;
  max-width: 200px;
  font-size: 12px;
}

/* Control de coordenadas responsive */
.mouse-coords {
  font-size: 10px !important;
  padding: 2px 4px !important;
  background: rgba(255,255,255,0.9) !important;
  border-radius: 3px;
}

/* Controles de Leaflet optimizados para móviles */
.leaflet-control-layers {
  max-width: 250px !important;
  font-size: 12px !important;
}

.leaflet-control-layers-expanded {
  padding: 6px 8px 6px 6px !important;
}

/* Botón de descarga responsive */
.download-button {
  background: #28a745 !important;
  padding: 6px 10px !important;
  border-radius: 5px !important;
  text-align: center !important;
  box-shadow: 0px 2px 6px rgba(0,0,0,0.3) !important;
  font-weight: normal !important;
  cursor: pointer !important;
  font-size: 12px !important;
  max-width: 200px !important;
}

.download-button a {
  color: white !important;
  text-decoration: none !important;
  display: block !important;
}

/* Media queries para diferentes tamaños de pantalla */
@media (max-width: 768px) {
  .header-container img {
    max-height: 60px;
  }
  
  .leaflet-popup-content {
    max-width: 150px;
    font-size: 11px;
  }
  
  .leaflet-control-layers {
    max-width: 200px !important;
    font-size: 11px !important;
  }
  
  .download-button {
    font-size: 10px !important;
    padding: 4px 8px !important;
    max-width: 180px !important;
  }
  
  .mouse-coords {
    font-size: 9px !important;
  }
}

@media (max-width: 480px) {
  .header-container img {
    max-height: 50px;
  }
  
  .leaflet-popup-content {
    max-width: 120px;
    font-size: 10px;
  }
  
  .leaflet-control-layers {
    max-width: 180px !important;
    font-size: 10px !important;
  }
  
  .download-button {
    font-size: 9px !important;
    padding: 3px 6px !important;
    max-width: 160px !important;
  }
  
  .mouse-coords {
    display: none !important;
  }
}
</style>

<!-- Encabezado personalizado responsive -->
<div class="header-container">
  <img src="https://raw.githubusercontent.com/MontserratJB/Geovisor/main/encabezado.png"
       alt="Encabezado Geovisor">
</div>
```

```{r cargadatos}
# Lectura de datos
mojones <- st_read("https://raw.githubusercontent.com/MontserratJB/Geovisor/refs/heads/main/Mojones.geojson", quiet = TRUE)
cantones <- st_read("https://raw.githubusercontent.com/MontserratJB/Geovisor/refs/heads/main/Cantones.geojson", quiet = TRUE)
```

```{r mapa-leaflet}
# Icono de mojones
icono_mojones <- makeIcon(
  iconUrl = "https://raw.githubusercontent.com/MontserratJB/Geovisor/main/pin.png",
  iconWidth = 18,
  iconHeight = 18
)

# Crear popups dinámicos
popup_mojones <- lapply(seq_len(nrow(mojones)), function(i) {
  row <- mojones[i, ]
  content <- paste(
    sapply(names(row), function(n) {
      valor <- row[[n]]
      
      # Omitir geometría
      if (n == "geometry") {
        return(NULL)
      }
      
      # Manejar valores nulos
      if (is.null(valor) || length(valor) == 0) {
        valor <- "Sin información"
      } else {
        valor <- as.character(valor)[1]
      }
      
      if (is.na(valor) || valor == "" || valor == "NA") {
        valor <- "Sin información"
      }
      
      # Verificar URL
      is_url <- grepl("^https?://", valor, ignore.case = TRUE)
      
      # Truncar texto largo
      if (!is_url && nchar(valor) > 30) {
        valor <- paste0(substr(valor, 1, 30), "...")
      }
      
      if (is_url) {
        paste0("<strong>", n, ":</strong><br>",
               "<a href='", valor, "' target='_blank' style='font-size:10px;'>Ver enlace</a>")
      } else {
        paste0("<strong>", n, ":</strong> ", valor)
      }
    }),
    collapse = "<br>"
  )
  
  # Limpiar contenido
  content <- gsub("<br><br>", "<br>", content)
  content <- gsub("^<br>|<br>$", "", content)
  return(content)
})

# Crear mapa estático
mapa <- leaflet() %>%
  setView(lng = -83.912, lat = 9.45, zoom = 8) %>%
  
  # Mapas base
  addProviderTiles(providers$CartoDB.DarkMatter, group = "CartoDB-Black") %>%
  addTiles(group = "OSM") %>%
  addProviderTiles("Esri.WorldImagery", group = "ESRI") %>%
  
  # Capas vectoriales
  addPolygons(
    data = cantones,
    color = "blue",
    fillColor = "transparent",
    stroke = TRUE,
    weight = 2.5,
    group = "Cantones"
  ) %>%
  
  addMarkers(
    data = mojones,
    lng = ~Longitud,
    lat = ~Latitud,
    icon = icono_mojones,
    popup = popup_mojones,
    group = "Mojones",
    options = markerOptions(riseOnHover = TRUE)
  ) %>%
  
  # Capa WMS
  addWMSTiles(
    baseUrl = "https://siri.snitcr.go.cr/Geoservicios/wms?",
    layers = "catastro:catastro",
    options = WMSTileOptions(
      format = "image/png",
      transparent = TRUE
    ),
    group = "Zona Catastrada"
  ) %>%
  
  hideGroup("Zona Catastrada") %>%
  
  # Control de capas en esquina superior derecha (bajo botón de descarga)
  addLayersControl(
    baseGroups = c("ESRI", "CartoDB-Black", "OSM"),
    overlayGroups = c("Cantones", "Zona Catastrada", "Mojones"),
    options = layersControlOptions(collapsed = TRUE, autoZIndex = TRUE),
    position = "topright"
  ) %>%
  
  addScaleBar("bottomright", options = scaleBarOptions(imperial = FALSE)) %>%
  addMiniMap(
    tiles = providers$CartoDB.Positron,
    toggleDisplay = TRUE,
    minimized = TRUE,
    width = 80,
    height = 80
  ) %>%
  addResetMapButton() %>%
  addFullscreenControl() %>%
  addControlGPS(options = list(showPopup = FALSE)) %>%
  addSearchOSM() %>%
  
  # Botón de descarga
  addControl(
    html = '<div class="download-button">
              <a href="https://drive.google.com/uc?export=download&id=1vlRIi4IuviA7z_9T0G6np-4OVXj-1vWe" target="_blank">
                📍 Descargar Mojones
              </a>
            </div>',
    position = "topright"
  ) %>%
  
  # Coordenadas del mouse
  onRender("
    function(el, x) {
      var map = this;
      var isMobile = window.innerWidth <= 480;
      
      if (!isMobile) {
        var coordsDiv = L.control({position: 'bottomleft'});
  
        coordsDiv.onAdd = function () {
          this._div = L.DomUtil.create('div', 'mouse-coords');
          this._div.innerHTML = 'Mueve el cursor sobre el mapa';
          return this._div;
        };
  
        coordsDiv.addTo(map);
  
        map.on('mousemove', function(e) {
          coordsDiv._div.innerHTML = 
            'Lat: ' + e.latlng.lat.toFixed(5) + 
            ' , Lng: ' + e.latlng.lng.toFixed(5);
        });
      }
      
      // Optimización para dispositivos táctiles
      if ('ontouchstart' in window) {
        map.dragging.disable();
        map.tap.disable();
        setTimeout(function() {
          map.dragging.enable();
          map.tap.enable();
        }, 1000);
      }
    }
  ")

# Mostrar mapa
mapa
```