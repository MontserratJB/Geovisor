---
title: "Proyecto de amojonamiento, datos GNSS"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
---



```{r setup, include=FALSE}
library(flexdashboard)
```


```{r import, warning=FALSE, message=FALSE}
# Paquete para manipulación de datos
library(dplyr)

# Paquete para manejo de datos vectoriales
library(sf)

# Paquetes para manejo de datos raster
library(terra)
library(raster)

# Paquete para mapas interactivos
library(leaflet)
library(leaflet.providers)
library(leaflet.extras)
library(leaflet.extras2)

# Paquetes para graficación
library(ggplot2)
library(plotly)

library(DT)

library(tidyverse)

library(htmlwidgets)
library(htmltools)
library(purrr)

```

```{r cargadatos}
# Lectura de una capa vectorial (GeoJSON) de provincias proyectos de Montes de Oca
mojones <-
  st_read(
    "https://raw.githubusercontent.com/MontserratJB/Geovisor/refs/heads/main/Mojones.geojson",
    quiet = TRUE
  )

# Lectura de una capa vectorial (GeoJSON) de distritos de Montes de Oca
cantones <-
  st_read(
    "https://raw.githubusercontent.com/MontserratJB/Geovisor/refs/heads/main/Cantones.geojson",
    quiet = TRUE
  )

# Lectura de un archivo CSV con datos de Presupuestos participativos en Montes de Oca
presupuesto <-
  st_read(
    "/vsicurl/https://raw.githubusercontent.com/MontserratJB/Geovisor/refs/heads/main/Pres_part.csv",
    options = c(
      "X_POSSIBLE_NAMES=decimalLongitude",
      "Y_POSSIBLE_NAMES=decimalLatitude"
    ),
    quiet = TRUE
  )
```


Column {data-width=450}
-----------------------------------------------------------------------

### Mapa

```{r mapa-leaflet}

#Icono de mojones
icono_mojones <- makeIcon(
  iconUrl = "https://raw.githubusercontent.com/MontserratJB/Geovisor/main/pin.png",
  iconWidth = 20,
  iconHeight = 20
)


# Crear los popups dinámicos con hipervínculos cuando el valor es URL
popup_mojones <- lapply(seq_len(nrow(mojones)), function(i) {
  row <- mojones[i, ]
  paste(
    sapply(names(row), function(n) {
      valor <- row[[n]]
      if (grepl("^https?://", valor)) {
        paste0("<strong>", n, ":</strong> ",
               "<a href='", valor, "' target='_blank'>", valor, "</a>")
      } else {
        paste0("<strong>", n, ":</strong> ", valor)
      }
    }),
    collapse = "<br>"
  )
})


#Creación del mapa con mapas base
leaflet() %>%
  setView(lng = -83.912, 
          lat = 9.78, 
          zoom = 8) %>%
    addProviderTiles(providers$CartoDB.DarkMatter, group = "CartoDB-Black") %>%
    addTiles(group = "OSM") %>%
    addProviderTiles("Esri.WorldImagery", group = "ESRI") %>%
    
    addScaleBar() %>% 
 
  addPolygons(
    data = cantones,
    color = "blue",
    fillColor = "transparent",
    stroke = TRUE,
    weight = 3.0,
    group = "Cantones"
    ) %>%
  
  
  addMarkers(
   data = mojones,
   lng = ~Longitud,
   lat = ~Latitud,
   icon = icono_mojones,
   popup = popup_mojones,
   group = "Mojones"
  ) %>%
  
  
  addWMSTiles(
    baseUrl = "https://siri.snitcr.go.cr/Geoservicios/wms?",
    layers = "catastro",
    options = WMSTileOptions(
      format = "image/png",
      transparent = TRUE
    ),
    group = "Zona Catastrada"
  ) %>%


  addLayersControl(
    baseGroups = c("ESRI", "CartoDB-Black", "OSM"),
    overlayGroups = c("Cantones", "Zona Catastrada", "Mojones"),
    options = layersControlOptions(collapsed = TRUE),
    position = "bottomleft"
  ) %>%
    
    addScaleBar("bottomright") %>%
    addMiniMap() %>%
    addResetMapButton() %>%
    addFullscreenControl() %>%
    addControlGPS() %>%
    addSearchOSM() %>%
  
#Creacion de las coordenadas del cursor    
     onRender("
        function(el, x) {
        var map = this;

        var coordsDiv = L.control({position: 'bottomleft'});
  
        coordsDiv.onAdd = function () {
          this._div = L.DomUtil.create('div', 'mouse-coords');
          this._div.style.padding = '4px';
          this._div.style.background = 'rgba(255,255,255,0.8)';
          this._div.style.font = '12px sans-serif';
          this._div.innerHTML = 'Move the mouse over the map';
          return this._div;
        };
  
        coordsDiv.addTo(map);
  
        map.on('mousemove', function(e) {
          coordsDiv._div.innerHTML = 
            'Lat: ' + e.latlng.lat.toFixed(5) + 
            ' , Lng: ' + e.latlng.lng.toFixed(5);
        });
    }
  ")

```



