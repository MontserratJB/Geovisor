---
title: "Proyecto de amojonamiento, datos GNSS"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme: bootstrap
---

<style>
/* Encabezado azul oscuro simple */
.navbar-inverse {
  background-color: #1a365d !important;
  border-color: #1a365d !important;
}

.navbar-inverse .navbar-brand {
  color: white !important;
  font-family: 'Titillium Web', sans-serif;
  font-weight: 600;
  padding-left: 20px !important;
}

.navbar-inverse .navbar-nav > li > a {
  color: white !important;
}

/* Mapa responsive */
.leaflet-container {
  width: 100% !important;
  height: 100% !important;
}
</style>

<link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@400;600;700&display=swap" rel="stylesheet">

```{r paquetes, include=FALSE}
library(flexdashboard)
library(dplyr)
library(sf)
library(leaflet)
library(leaflet.providers)
library(leaflet.extras)
library(leaflet.extras2)
library(htmltools)
library(htmlwidgets)
```

```{r carga_datos, include=FALSE}
# Lectura de una capa vectorial (GeoJSON) de mojones
mojones <-
  st_read(
    "https://raw.githubusercontent.com/MontserratJB/Geovisor/refs/heads/main/Mojones.geojson",
    quiet = TRUE
  )

# Lectura de una capa vectorial (GeoJSON) de cantones
cantones <-
  st_read(
    "https://raw.githubusercontent.com/MontserratJB/Geovisor/refs/heads/main/Cantones.geojson",
    quiet = TRUE
  )
```

Row
-----------------------------------------------------------------------

### Mapa interactivo, Comisi칩n GNSS CIT

```{r mapa}
# Estilo global para popups
tags$style(HTML("
  .leaflet-popup-content {
    white-space: normal !important;
    word-wrap: break-word !important;
    max-width: 250px;
    min-width: 200px;  /* asegura un ancho m칤nimo uniforme */
  }
"))

# Icono de mojones
icono_mojones <- makeIcon(
  iconUrl = "https://raw.githubusercontent.com/MontserratJB/Geovisor/main/pin.png",
  iconWidth = 20,
  iconHeight = 20
)

# Crear los popups din치micos con hiperv칤nculos cuando el valor es URL
popup_mojones <- lapply(seq_len(nrow(mojones)), function(i) {
  row <- mojones[i, ]
  
  # Aplicamos sapply y luego eliminamos NULL, NA o cadenas vac칤as
  campos <- sapply(names(row), function(n) {
    valor <- row[[n]]
    
    # Omitir geometr칤a
    if (n == "geometry") {
      return(NA)
    }
    
    # Manejar valores nulos de forma segura
    if (is.null(valor) || length(valor) == 0) {
      valor <- "Sin informaci칩n"
    } else {
      valor <- trimws(as.character(valor)[1])  # trimws elimina espacios antes/despu칠s
    }
    
    # Verificar valores vac칤os o NA
    if (is.na(valor) || valor == "" || valor == "NA") {
      valor <- "Sin informaci칩n"
    }
    
    # Verificar si es URL
    if (grepl("^https?://", valor, ignore.case = TRUE)) {
      paste0("<strong>", n, ":</strong> ",
             "<a href='", valor, "' target='_blank'>Ver enlace</a>")
    } else {
      paste0("<strong>", n, ":</strong> ", valor)
    }
  }, USE.NAMES = FALSE)
  
  # Filtrar resultados vac칤os o NA antes de concatenar
  campos <- campos[!is.na(campos) & campos != ""]
  
  paste(campos, collapse = "<br>")
})

# Creaci칩n del mapa con mapas base
mapa <- leaflet() %>%
  setView(lng = -83.912,
          lat = 9.78,
          zoom = 8) %>%
  addProviderTiles(providers$CartoDB.DarkMatter, group = "CartoDB-Black") %>%
  addTiles(group = "OSM") %>%
  addProviderTiles("Esri.WorldImagery", group = "ESRI") %>%
  
  addScaleBar() %>%
  
  addPolygons(
    data = cantones,
    color = "blue",
    fillColor = "transparent",
    stroke = TRUE,
    weight = 3.0,
    group = "Cantones"
  ) %>%
  
  addMarkers(
    data = mojones,
    lng = ~Longitud,
    lat = ~Latitud,
    icon = icono_mojones,
    popup = popup_mojones,
    group = "Mojones"
  ) %>%
  
  addWMSTiles(
    baseUrl = "https://siri.snitcr.go.cr/Geoservicios/wms?",
    layers = "catastro:catastro",
    options = WMSTileOptions(
      format = "image/png",
      transparent = TRUE
    ),
    group = "Zona Catastrada"
  ) %>%
  
  hideGroup("Zona Catastrada") %>%
  addLayersControl(
    baseGroups = c("ESRI", "CartoDB-Black", "OSM"),
    overlayGroups = c("Cantones", "Zona Catastrada", "Mojones"),
    options = layersControlOptions(collapsed = TRUE),
    position = "bottomleft"
  ) %>%
  
  addScaleBar("bottomright") %>%
  addResetMapButton() %>%
  addFullscreenControl() %>%
  addSearchOSM() %>%
  addMeasure(
    position = "bottomleft",
    primaryLengthUnit = "meters",
    primaryAreaUnit = "hectares",
    activeColor = "#3D535D",
    completedColor = "#7D4479"
  ) %>%
  addControlGPS() %>%
  
  # Botones de descarga
  addControl(
    html = '
    <div style="
         background:#28a745;
         padding:4px 8px;
         border-radius:5px;
         text-align:center;
         box-shadow: 0px 2px 6px rgba(0,0,0,0.3);
         font-weight: normal;
         cursor:pointer;">
      <a href="https://drive.google.com/uc?export=download&id=1vlRIi4IuviA7z_9T0G6np-4OVXj-1vWe"
         target="_blank"
         style="color:white; text-decoration:none;">
         游늸 Descargar capa Mojones
      </a>
    </div>
    ',
    position = "topright"
  ) %>%
  
  # Creacion de las coordenadas del cursor
  onRender("
    function(el, x) {
      var map = this;

      var coordsDiv = L.control({position: 'bottomleft'});

      coordsDiv.onAdd = function () {
        this._div = L.DomUtil.create('div', 'mouse-coords');
        this._div.style.padding = '4px';
        this._div.style.background = 'rgba(255,255,255,0.8)';
        this._div.style.font = '12px sans-serif';
        this._div.innerHTML = 'Move the mouse over the map';
        return this._div;
      };

      coordsDiv.addTo(map);

      map.on('mousemove', function(e) {
        coordsDiv._div.innerHTML =
          'Lat: ' + e.latlng.lat.toFixed(5) +
          ' , Lng: ' + e.latlng.lng.toFixed(5);
      });
    }
  ")

# Mostrar el mapa directamente
mapa
```