---
title: ""
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    navbar:
      - { title: "", href: "#" }
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(dplyr)
library(sf)
library(terra)
library(raster)
library(leaflet)
library(leaflet.providers)
library(leaflet.extras)
library(leaflet.extras2)
library(ggplot2)
library(plotly)
library(DT)
library(tidyverse)
library(htmlwidgets)
library(htmltools)
library(purrr)
library(shiny)
library(shinydashboard)
```

```{=html}
<!-- CSS para ocultar completamente el encabezado de flexdashboard -->
<style>
.navbar-brand {
  display: none !important;
}
.navbar-header {
  display: none !important;
}
.navbar {
  display: none !important;
}
.navbar-inverse {
  display: none !important;
}
.section.level1 h1 {
  display: none !important;
}
/* Eliminar cualquier encabezado azul */
.chart-title {
  display: none !important;
}
/* Asegurar que el contenido ocupe todo el espacio */
body, html {
  margin: 0 !important;
  padding: 0 !important;
}
.container-fluid {
  padding: 0 !important;
}
</style>

<!-- Encabezado personalizado con imagen -->
<div style="width: 100%; text-align: center; background-color: #ffffff; padding: 0px; margin: 0px;">
  <img src="https://raw.githubusercontent.com/MontserratJB/Geovisor/main/encabezado.png"
       style="width: 100%; height: auto; display: block; margin: 0;">
</div>
```

```{r cargadatos}
# Lectura de una capa vectorial (GeoJSON) de provincias proyectos de Montes de Oca
mojones <-
  st_read(
    "https://raw.githubusercontent.com/MontserratJB/Geovisor/refs/heads/main/Mojones.geojson",
    quiet = TRUE
  )

# Lectura de una capa vectorial (GeoJSON) de distritos de Montes de Oca
cantones <-
  st_read(
    "https://raw.githubusercontent.com/MontserratJB/Geovisor/refs/heads/main/Cantones.geojson",
    quiet = TRUE
  )

```


```{r mapa-leaflet}

# Estilo global para popups
tags$style(HTML("
  .leaflet-popup-content {
    white-space: normal !important;
    word-wrap: break-word !important;
    max-width: 250px;
  }
"))

#Icono de mojones
icono_mojones <- makeIcon(
  iconUrl = "https://raw.githubusercontent.com/MontserratJB/Geovisor/main/pin.png",
  iconWidth = 20,
  iconHeight = 20
)


# Crear los popups din√°micos con hiperv√≠nculos cuando el valor es URL
popup_mojones <- lapply(seq_len(nrow(mojones)), function(i) {
  row <- mojones[i, ]
  paste(
    sapply(names(row), function(n) {
      valor <- row[[n]]
      if (grepl("^https?://", valor)) {
        paste0("<strong>", n, ":</strong> ",
               "<a href='", valor, "' target='_blank'>", valor, "</a>")
      } else {
        paste0("<strong>", n, ":</strong> ", valor)
      }
    }),
    collapse = "<br>"
  )
})

#Creaci√≥n del mapa con mapas base
output$mapa <- renderLeaflet({
leaflet() %>%
  setView(lng = -83.912, 
          lat = 9.78, 
          zoom = 8) %>%
    addProviderTiles(providers$CartoDB.DarkMatter, group = "CartoDB-Black") %>%
    addTiles(group = "OSM") %>%
    addProviderTiles("Esri.WorldImagery", group = "ESRI") %>%
    
    addScaleBar() %>% 
 
  addPolygons(
    data = cantones,
    color = "blue",
    fillColor = "transparent",
    stroke = TRUE,
    weight = 3.0,
    group = "Cantones"
    ) %>%
  
  
  addMarkers(
   data = mojones,
   lng = ~Longitud,
   lat = ~Latitud,
   icon = icono_mojones,
   popup = popup_mojones,
   group = "Mojones"
  ) %>%
  
  
  addWMSTiles(
    baseUrl = "https://siri.snitcr.go.cr/Geoservicios/wms?",
    layers = "catastro:catastro",
    options = WMSTileOptions(
      format = "image/png",
      transparent = TRUE
    ),
    group = "Zona Catastrada"
  ) %>%
    
  hideGroup("Zona Catastrada") %>%  # <- esto la oculta al inicio
  addLayersControl(
    baseGroups = c("ESRI", "CartoDB-Black", "OSM"),
    overlayGroups = c("Cantones", "Zona Catastrada", "Mojones"),
    options = layersControlOptions(collapsed = TRUE),
    position = "bottomleft"
  )%>%

    addScaleBar("bottomright") %>%
    addMiniMap() %>%
    addResetMapButton() %>%
    addFullscreenControl() %>%
    addControlGPS() %>%
    addSearchOSM() %>%
  
#Botones de descarga
  addControl(
  html = '
  <div style="
       background:#28a745;           /* color verde */
       padding:4px 8px;              /* espacio interno */
       border-radius:5px;            /* bordes redondeados */
       text-align:center; 
       box-shadow: 0px 2px 6px rgba(0,0,0,0.3);
       font-weight: normal;           /* letra normal */
       cursor:pointer;">
    <a href="https://drive.google.com/uc?export=download&id=1vlRIi4IuviA7z_9T0G6np-4OVXj-1vWe" 
       target="_blank" 
       style="color:white; text-decoration:none;">
       üìç Descargar capa Mojones
    </a>
  </div>
  ',
  position = "topright"
) %>%
  
#Creacion de las coordenadas del cursor    
     onRender("
        function(el, x) {
        var map = this;

        var coordsDiv = L.control({position: 'bottomleft'});
  
        coordsDiv.onAdd = function () {
          this._div = L.DomUtil.create('div', 'mouse-coords');
          this._div.style.padding = '4px';
          this._div.style.background = 'rgba(255,255,255,0.8)';
          this._div.style.font = '12px sans-serif';
          this._div.innerHTML = 'Move the mouse over the map';
          return this._div;
        };
  
        coordsDiv.addTo(map);
  
        map.on('mousemove', function(e) {
          coordsDiv._div.innerHTML = 
            'Lat: ' + e.latlng.lat.toFixed(5) + 
            ' , Lng: ' + e.latlng.lng.toFixed(5);
        });
    }
  ")
})

# Output del mapa
leafletOutput("mapa", height = "600px")


```





